/*
* SelectBox - A Drop-down Builder for Styleable Inputs and Menus
* Version: 2.1.5
* License: Creative Commons Attribution 3.0 Unported - CC BY 3.0
* http://creativecommons.org/licenses/by/3.0/
* This software may be used freely on commercial and non-commercial projects with attribution to the author/copyright holder.
* Author: Patrick Kunka, Flatmates Team
* Copyright 2014 Patrick Kunka, Flatmates Team, All Rights Reserved
*/

(function(e){function t(){this.isField=true,this.down=false,this.inFocus=false,this.disabled=false,this.cutOff=false,this.hasLabel=false,this.keyboardMode=false,this.nativeTouch=true,this.wrapperClass="dropdown",this.onChange=null}t.prototype={constructor:t,instances:{},init:function(t,n){var r=this;e.extend(r,n);r.$select=e(t);r.id=t.id;r.options=[];r.$options=r.$select.find("option");r.isTouch="ontouchend"in document;r.$select.removeClass(r.wrapperClass+" dropdown");if(r.$select.is(":disabled")){r.disabled=true}if(r.$options.length){r.$options.each(function(t){var n=e(this);if(n.is(":selected")){r.selected={index:t,title:n.text()};r.focusIndex=t}if(n.hasClass("label")&&t==0){r.hasLabel=true;r.label=n.text();n.attr("value","")}else{r.options.push({domNode:n[0],title:n.text(),value:n.val(),selected:n.is(":selected")})}});if(!r.selected){r.selected={index:0,title:r.$options.eq(0).text()};r.focusIndex=0}r.render()}},render:function(){var t=this,n=t.isTouch&&t.nativeTouch?" touch":"",r=t.disabled?" disabled":"";t.$container=t.$select.wrap('<div class="'+t.wrapperClass+n+r+'"><span class="old"/></div>').parent().parent();t.$active=e('<span class="selected">'+t.selected.title+"</span>").appendTo(t.$container);t.$carat=e('<span class="carat"/>').appendTo(t.$container);t.$scrollWrapper=e("<div><ul/></div>").appendTo(t.$container);t.$dropDown=t.$scrollWrapper.find("ul");t.$form=t.$container.closest("form");e.each(t.options,function(){var e=this,n=e.selected?' class="active"':"";t.$dropDown.append("<li"+n+">"+e.title+"</li>")});t.$items=t.$dropDown.find("li");if(t.cutOff&&t.$items.length>t.cutOff)t.$container.addClass("scrollable");t.getMaxHeight();if(t.isTouch&&t.nativeTouch){t.bindTouchHandlers()}else{t.bindHandlers()}},getMaxHeight:function(){var e=this;e.maxHeight=0;for(i=0;i<e.$items.length;i++){var t=e.$items.eq(i);e.maxHeight+=t.outerHeight();if(e.cutOff==i+1){break}}},bindTouchHandlers:function(){var t=this;t.$container.on("click.selectBox",function(){t.$select.focus()});t.$select.on({change:function(){var n=e(this).find("option:selected"),r=n.text(),i=n.val();t.$active.text(r);if(typeof t.onChange==="function"){t.onChange.call(t.$select[0],{title:r,value:i})}},focus:function(){t.$container.addClass("focus")},blur:function(){t.$container.removeClass("focus")}})},bindHandlers:function(){var t=this;t.query="";t.$container.on({"click.selectBox":function(){if(!t.down&&!t.disabled){t.open()}else{t.close()}},"mousemove.selectBox":function(){if(t.keyboardMode){t.keyboardMode=false}}});e("body").on("click.selectBox."+t.id,function(n){var r=e(n.target),i=t.wrapperClass.split(" ").join(".");if(!r.closest("."+i).length&&t.down){t.close()}});t.$items.on({"click.selectBox":function(){var n=e(this).index();t.select(n);t.$select.focus()},"mouseover.selectBox":function(){if(!t.keyboardMode){var n=e(this);n.addClass("focus").siblings().removeClass("focus");t.focusIndex=n.index()}},"mouseout.selectBox":function(){if(!t.keyboardMode){e(this).removeClass("focus")}}});t.$select.on({"focus.selectBox":function(){t.$container.addClass("focus");t.inFocus=true},"blur.selectBox":function(){t.$container.removeClass("focus");t.inFocus=false},"keydown.selectBox":function(e){if(t.inFocus){t.keyboardMode=true;var n=e.keyCode;if(n==38||n==40||n==32){e.preventDefault();if(n==38){t.focusIndex--;t.focusIndex=t.focusIndex<0?t.$items.length-1:t.focusIndex}else if(n==40){t.focusIndex++;t.focusIndex=t.focusIndex>t.$items.length-1?0:t.focusIndex}if(!t.down){t.open()}t.$items.removeClass("focus").eq(t.focusIndex).addClass("focus");if(t.cutOff){t.scrollToView()}t.query=""}if(t.down){if(n==9||n==27){t.close()}else if(n==13){e.preventDefault();t.select(t.focusIndex);t.close();return false}else if(n==8){e.preventDefault();t.query=t.query.slice(0,-1);t.search();clearTimeout(t.resetQuery);return false}else if(n!=38&&n!=40){var r=String.fromCharCode(n);t.query+=r;t.search();clearTimeout(t.resetQuery)}}}},"keyup.selectBox":function(){t.resetQuery=setTimeout(function(){t.query=""},1200)}});t.$dropDown.on("scroll.selectBox",function(e){if(t.$dropDown[0].scrollTop>=t.$dropDown[0].scrollHeight-t.maxHeight){t.$container.addClass("bottom")}else{t.$container.removeClass("bottom")}});if(t.$form.length){t.$form.on("reset.selectBox",function(){var e=t.hasLabel?t.label:t.options[0].title;t.$active.text(e)})}},unbindHandlers:function(){var t=this;t.$container.add(t.$select).add(t.$items).add(t.$form).add(t.$dropDown).off(".selectBox");e("body").off("."+t.id)},open:function(){var e=this,t=window.scrollY||document.documentElement.scrollTop,n=window.scrollX||document.documentElement.scrollLeft,r=e.notInViewport(t);e.closeAll();e.getMaxHeight();e.$select.focus();window.scrollTo(n,t+r);e.$container.addClass("open");e.$scrollWrapper.css("height",e.maxHeight+"px");e.down=true},close:function(){var e=this;e.$container.removeClass("open");e.$scrollWrapper.css("height","0px");e.focusIndex=e.selected.index;e.query="";e.down=false},closeAll:function(){var e=this,t=Object.getPrototypeOf(e).instances;for(var n in t){var r=t[n];r.close()}},select:function(e){var t=this;if(typeof e==="string"){e=t.$select.find("option[value="+e+"]").index()}var n=t.options[e],r=t.hasLabel?e+1:e;t.$items.removeClass("active").eq(e).addClass("active");t.$active.text(n.title);t.$select.find("option").removeAttr("selected").eq(r).prop("selected",true).parent().trigger("change");t.selected={index:e,title:n.title};t.focusIndex=i;if(typeof t.onChange==="function"){t.onChange.call(t.$select[0],{title:n.title,value:n.value})}},search:function(){var e=this,t=function(t){e.focusIndex=t;e.$items.removeClass("focus").eq(e.focusIndex).addClass("focus");e.scrollToView()},n=function(t){return e.options[t].title.toUpperCase()};for(i=0;i<e.options.length;i++){var r=n(i);if(r.indexOf(e.query)==0){t(i);return}}for(i=0;i<e.options.length;i++){var r=n(i);if(r.indexOf(e.query)>-1){t(i);break}}},scrollToView:function(){var e=this;if(e.focusIndex>=e.cutOff){var t=e.$items.eq(e.focusIndex),n=t.outerHeight()*(e.focusIndex+1)-e.maxHeight;e.$dropDown.scrollTop(n)}},notInViewport:function(e){var t=this,n={min:e,max:e+(window.innerHeight||document.documentElement.clientHeight)},r=t.$dropDown.offset().top+t.maxHeight;if(r>=n.min&&r<=n.max){return 0}else{return r-n.max+5}},destroy:function(){var e=this;e.unbindHandlers();e.$select.unwrap().siblings().remove();e.$select.unwrap();delete Object.getPrototypeOf(e).instances[e.$select[0].id]},disable:function(){var e=this;e.disabled=true;e.$container.addClass("disabled");e.$select.attr("disabled",true);if(!e.down)e.close()},enable:function(){var e=this;e.disabled=false;e.$container.removeClass("disabled");e.$select.attr("disabled",false)},update:function(){var e=this;e.select(e.$select.find("option:selected").index())}};var n=function(e,n){e.id=!e.id?"SelectBox"+r():e.id;var i=new t;if(!i.instances[e.id]){i.instances[e.id]=i;i.init(e,n)}},r=function(){return("00000"+(Math.random()*16777216<<0).toString(16)).substr(-6).toUpperCase()};e.fn.selectBox=function(){var e=arguments,r=[],i;i=this.each(function(){if(e&&typeof e[0]==="string"){var i=t.prototype.instances[this.id][e[0]](e[1],e[2]);if(i)r.push(i)}else{n(this,e[0])}});if(r.length){return r.length>1?r:r[0]}else{return i}};e(function(){if(typeof Object.getPrototypeOf!=="function"){if(typeof "test".__proto__==="object"){Object.getPrototypeOf=function(e){return e.__proto__}}else{Object.getPrototypeOf=function(e){return e.constructor.prototype}}}e("select.dropdown").each(function(){var t=e(this).attr("data-settings");settings=t?e.parseJSON(t):{};n(this,settings)})})})(jQuery)